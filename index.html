<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>API账号管理（发送管控原型）</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --text:#101828;
      --muted:#667085;
      --line:#e4e7ec;
      --primary:#1677ff;
      --danger:#d92d20;
      --success:#12b76a;
      --shadow:0 10px 28px rgba(16,24,40,.08);
      --radius:12px;
      --font: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, "Noto Sans";
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:var(--font);color:var(--text);background:var(--bg);}

    .topbar{
      height:52px;
      background:linear-gradient(90deg,#0b1220,#0a1b3a);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 18px;
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .logo{width:30px;height:30px;border-radius:10px;background:linear-gradient(135deg,#12b76a,#1677ff)}
    .topbar .right{display:flex;align-items:center;gap:16px;font-size:13px;opacity:.92}

    .layout{display:flex;min-height:calc(100vh - 56px)}

    .sidebar{
      width:240px;
      background:var(--panel);
      border-right:1px solid var(--line);
      padding:12px 10px;
    }
    .nav-title{font-size:12px;color:var(--muted);margin:10px 10px 6px}
    .nav a{display:flex;align-items:center;gap:10px;padding:10px 10px;margin:2px 6px;border-radius:10px;color:var(--text);text-decoration:none;font-size:14px;}
    .nav a.active{background:#eef4ff;color:#0b4fd6;font-weight:700}
    .nav a:hover{background:#f2f4f7}

    .content{flex:1;padding:18px;background:transparent}
    .container{max-width:1280px;margin:0;}

    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card-header{padding:16px 18px;border-bottom:1px solid var(--line);display:flex;align-items:flex-start;justify-content:space-between;gap:12px;}
    .title{font-size:18px;margin:0;line-height:1.2}
    .subtitle{font-size:12px;color:var(--muted);margin-top:6px}

    .filters{padding:14px 18px;border-bottom:1px solid var(--line)}
    .grid{display:grid;grid-template-columns: 220px 220px minmax(360px, 1fr) 180px;gap:10px}
    .field label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    .field input,.field select{width:100%;height:36px;padding:0 12px;border:1px solid var(--line);border-radius:10px;background:#fff;outline:none;}
    .field input:focus,.field select:focus{border-color:#c9d7ff;box-shadow:0 0 0 4px rgba(22,119,255,.12)}
    .field.remark{min-width:360px}
    .field.remark input{width:100%}

    .actions{display:flex;gap:10px;margin-top:12px}
    .btn{padding:9px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font-size:14px;}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.ghost{background:#fff;color:var(--text)}

    .toolbar{padding:12px 18px;display:flex;gap:10px;align-items:center;justify-content:space-between;border-bottom:1px solid var(--line)}
    .toolbar .left{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      padding:12px 14px;
      background:#fbfcff;
      border-bottom:1px solid var(--line);
      position:sticky;
      top:0;
      z-index:1;
      white-space:nowrap;
    }
    tbody td{padding:14px;border-bottom:1px solid var(--line);vertical-align:top;font-size:14px;}
    tbody tr:hover{background:#fbfcff}

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .muted{color:var(--muted);font-size:12px}

    .tag{display:inline-flex;align-items:center;border-radius:999px;padding:4px 10px;font-size:12px;border:1px solid var(--line);background:#fff;color:var(--muted);white-space:nowrap;}
    .tag.success{background:#ecfdf3;border-color:#abefc6;color:#027a48}
    .tag.danger{background:#fef3f2;border-color:#fecdca;color:#b42318}

    .row-actions{display:flex;gap:12px;flex-wrap:wrap}
    .link{border:none;background:none;color:#0b4fd6;cursor:pointer;padding:0;font-size:14px}
    .link.danger{color:var(--danger)}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(16,24,40,.48);display:none;align-items:center;justify-content:center;padding:18px;z-index:50;}
    .modal-backdrop.show{display:flex}
    .modal{width:min(720px, 100%);background:#fff;border-radius:14px;box-shadow:var(--shadow);border:1px solid var(--line);overflow:hidden}
    .modal-header{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:12px}
    .modal-header h2{margin:0;font-size:16px}
    .modal-body{padding:14px 16px}
    .modal-footer{padding:14px 16px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;gap:10px}
    .close{border:none;background:none;font-size:20px;cursor:pointer;color:var(--muted)}

    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .span-2{grid-column:span 2}

    .switch{display:flex;align-items:center;gap:10px;padding:9px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;}
    .switch input{width:44px;height:22px;appearance:none;background:#d0d5dd;border-radius:999px;position:relative;outline:none;cursor:pointer}
    .switch input:checked{background:var(--primary)}
    .switch input:before{content:"";position:absolute;top:3px;left:3px;width:16px;height:16px;background:#fff;border-radius:50%;transition:transform .18s ease}
    .switch input:checked:before{transform:translateX(22px)}

    /* Toast */
    .toasts{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:10px;z-index:60;}
    .toast{min-width:280px;max-width:420px;background:#fff;border:1px solid var(--line);box-shadow:var(--shadow);border-radius:10px;padding:10px 12px;}
    .toast .title{font-size:13px;font-weight:800;margin-bottom:4px;}
    .toast .desc{font-size:12px;color:var(--muted);line-height:1.45}
    .toast.success{border-color:#abefc6}
    .toast.danger{border-color:#fecdca}

    @media (max-width: 1100px){
      .sidebar{display:none}
      .grid{grid-template-columns: 1fr 1fr;}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand"><span class="logo" aria-hidden="true"></span><span>阅信云</span></div>
    <div class="right"><span>开发文档</span><span>学习帮助</span><span class="mono">1591****2512</span></div>
  </div>

  <div class="layout">
    <aside class="sidebar">
      <div class="nav">
        <div class="nav-title">导航</div>
        <a href="#" class="active">API账号管理</a>
        <a href="#">导出记录</a>
        <a href="#">通讯录</a>
      </div>
    </aside>

    <main class="content">
      <div class="container">
        <section class="card">
          <div class="card-header">
            <div>
              <h1 class="title">API账号管理</h1>
              <div class="subtitle">（原型）新增：发送管控</div>
            </div>
          </div>

          <div class="filters">
            <div class="grid">
              <div class="field">
                <label>账号</label>
                <input type="text" placeholder="请输入账号" />
              </div>
              <div class="field">
                <label>发送账号</label>
                <select>
                  <option>全部</option>
                  <option>接口账号</option>
                  <option>企业</option>
                </select>
              </div>
              <div class="field remark">
                <label>备注</label>
                <input type="text" placeholder="请输入备注" />
              </div>
              <div class="field">
                <label>状态</label>
                <select>
                  <option>全部</option>
                  <option>正常</option>
                  <option>禁用</option>
                </select>
              </div>
            </div>
            <div class="actions">
              <button class="btn primary" type="button">查询</button>
              <button class="btn ghost" type="button">重置</button>
            </div>
          </div>

          <div class="toolbar">
            <div class="left">
              <button class="btn primary" type="button">申请API账号</button>
              <button class="btn" type="button">下载API文档</button>
            </div>
          </div>

          <div style="overflow:auto;max-height:calc(100vh - 300px);">
            <table>
              <thead>
                <tr>
                  <th style="min-width:130px;">账号</th>
                  <th style="min-width:210px;">密钥</th>
                  <th style="min-width:110px;">付费者</th>
                  <th style="min-width:120px;">IP白名单</th>
                  <th style="min-width:170px;">状态报告接收地址</th>
                  <th style="min-width:170px;">上行接收地址</th>
                  <th style="min-width:130px;">所属登录账号</th>
                  <th style="min-width:90px;">状态</th>
                  <th style="min-width:150px;">备注</th>

                  <th style="min-width:130px;">发送管控状态</th>
                  <th style="min-width:110px;">剩余可发(段)</th>
                  <th style="min-width:90px;">已用(段)</th>
                  <th style="min-width:120px;">管控模式</th>

                  <th style="min-width:220px;">操作</th>
                </tr>
              </thead>
              <tbody id="rows">
                <tr data-api="zipirbj2" data-control="off">
                  <td class="mono">zipirbj2</td>
                  <td class="mono">717478ddfa0bdc43c<br><span class="muted">（示例）</span></td>
                  <td>企业</td>
                  <td class="mono">0.0.0.0</td>
                  <td class="muted">-</td>
                  <td class="muted">-</td>
                  <td class="mono">18214024361</td>
                  <td>禁用</td>
                  <td class="muted">-</td>

                  <td data-col="controlState"></td>
                  <td data-col="remaining"></td>
                  <td data-col="used"></td>
                  <td data-col="mode"></td>

                  <td>
                    <div class="row-actions">
                      <button class="link" type="button">启用</button>
                      <button class="link" type="button">编辑</button>
                      <button class="link" type="button">重置密钥</button>
                      <button class="link" type="button">下载API文档</button>
                      <button class="link" type="button" data-action="set-control">发送管控设置</button>
                                          </div>
                  </td>
                </tr>

                <tr data-api="fyqcs02" data-control="on" data-remaining="1200" data-used="300" data-mode="once">
                  <td class="mono">fyqcs02</td>
                  <td class="mono">acf8bba8f2adceff731<br><span class="muted">（示例）</span></td>
                  <td>接口账号</td>
                  <td class="mono">0.0.0.0</td>
                  <td class="muted">-</td>
                  <td class="muted">-</td>
                  <td class="mono">15912982512</td>
                  <td>正常</td>
                  <td class="muted">-</td>

                  <td data-col="controlState"></td>
                  <td data-col="remaining"></td>
                  <td data-col="used"></td>
                  <td data-col="mode"></td>

                  <td>
                    <div class="row-actions">
                      <button class="link danger" type="button">禁用</button>
                      <button class="link" type="button">编辑</button>
                      <button class="link" type="button">重置密钥</button>
                      <button class="link" type="button">下载API文档</button>
                      <button class="link" type="button" data-action="set-control">发送管控设置</button>
                                          </div>
                  </td>
                </tr>

                <tr data-api="hgcmp2" data-control="limit" data-remaining="0" data-used="5000" data-mode="cycle-month" data-cycle-type="month" data-cycle-quota="5000">
                  <td class="mono">hgcmp2</td>
                  <td class="mono">d41d8cd98f00b204e<br><span class="muted">（示例）</span></td>
                  <td>接口账号</td>
                  <td class="mono">111.194.122.208</td>
                  <td class="mono">http://39.98.72.59:33219/callback/invoke2</td>
                  <td class="mono">http://39.98.72.59:33219/callback/invoke2</td>
                  <td class="mono">15912982512</td>
                  <td>正常</td>
                  <td class="muted">-</td>

                  <td data-col="controlState"></td>
                  <td data-col="remaining"></td>
                  <td data-col="used"></td>
                  <td data-col="mode"></td>

                  <td>
                    <div class="row-actions">
                      <button class="link danger" type="button">禁用</button>
                      <button class="link" type="button">编辑</button>
                      <button class="link" type="button">重置密钥</button>
                      <button class="link" type="button">下载API文档</button>
                      <button class="link" type="button" data-action="set-control">发送管控设置</button>
                                          </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Modal: Send Control Settings -->
  <div class="modal-backdrop" id="modalControl" role="dialog" aria-modal="true" aria-labelledby="modalControlTitle">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalControlTitle">发送管控设置</h2>
        <button class="close" type="button" data-close="modalControl" aria-label="关闭">×</button>
      </div>
      <div class="modal-body">
        <div class="muted" style="margin-bottom:10px;">API账号：<span class="mono" id="controlApi">-</span></div>

        <div class="form-grid">
          <div class="field span-2">
            <label>开启发送管控</label>
            <div class="switch">
              <input id="controlEnabled" type="checkbox" />
              <span class="muted">开启后将对该 API 账号生效。</span>
            </div>
          </div>

          <div class="field">
            <label>管控模式</label>
            <select id="controlMode">
              <option value="once">一次性</option>
              <option value="cycle">周期</option>
            </select>
          </div>

          <div class="field" id="cycleTypeWrap" style="display:none;">
            <label>周期类型</label>
            <select id="cycleType">
              <option value="day">按日</option>
              <option value="month">按月</option>
            </select>
          </div>

          <div class="field span-2" id="onceWrap">
            <label>可发余量(段)</label>
            <input id="onceRemaining" type="number" min="0" placeholder="请输入一次性可发余量" />
          </div>

          <div class="field span-2" id="cycleWrap" style="display:none;">
            <label>每周期可发量(段)</label>
            <input id="cycleQuota" type="number" min="0" placeholder="请输入每周期可发量" />
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" type="button" data-close="modalControl">取消</button>
        <button class="btn primary" type="button" data-save="control">保存</button>
      </div>
    </div>
  </div>

  <div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>

  <script>
    const STORAGE_KEY = 'sendControlPrototypeStateV1';
    const state = new Map();

    function toInt(v, fallback = 0) {
      const n = Number.parseInt(v, 10);
      return Number.isFinite(n) ? n : fallback;
    }

    function toast(kind, title, desc) {
      const el = document.createElement('div');
      el.className = `toast ${kind}`;
      el.innerHTML = `<div class="title">${title}</div><div class="desc">${desc}</div>`;
      document.getElementById('toasts').appendChild(el);
      setTimeout(() => {
        el.style.opacity = '0';
        el.style.transition = 'opacity .25s ease';
        setTimeout(() => el.remove(), 260);
      }, 2000);
    }

    function modeLabel(cfg) {
      if (!cfg.enabled) return '-';
      if (cfg.mode === 'cycle') return `周期（${cfg.cycleType === 'day' ? '按日' : '按月'}）`;
      return '一次性';
    }

    function controlTag(cfg) {
      if (!cfg.enabled) return `<span class="tag">未开启</span>`;
      if (cfg.remaining <= 0) return `<span class="tag danger">已达上限</span>`;
      return `<span class="tag success">已开启</span>`;
    }

    function renderRow(row) {
      const api = row.getAttribute('data-api');
      const cfg = state.get(api);

      row.querySelector('[data-col="controlState"]').innerHTML = controlTag(cfg);
      row.querySelector('[data-col="remaining"]').innerHTML = cfg.enabled ? `<span class="mono">${cfg.remaining}</span>` : `<span class="muted">-</span>`;
      row.querySelector('[data-col="used"]').innerHTML = cfg.enabled ? `<span class="mono">${cfg.used}</span>` : `<span class="muted">-</span>`;
      row.querySelector('[data-col="mode"]').innerHTML = cfg.enabled ? modeLabel(cfg) : `<span class="muted">-</span>`;

      row.setAttribute('data-control', cfg.enabled ? (cfg.remaining <= 0 ? 'limit' : 'on') : 'off');
      row.setAttribute('data-remaining', String(cfg.remaining));
      row.setAttribute('data-used', String(cfg.used));
      row.setAttribute('data-mode', cfg.mode === 'cycle' ? `cycle-${cfg.cycleType}` : 'once');
      if (cfg.mode === 'cycle') {
        row.setAttribute('data-cycle-type', cfg.cycleType);
        row.setAttribute('data-cycle-quota', String(cfg.cycleQuota ?? 0));
      } else {
        row.removeAttribute('data-cycle-type');
        row.removeAttribute('data-cycle-quota');
      }
    }

    function renderAll() {
      document.querySelectorAll('#rows tr[data-api]').forEach(renderRow);
      persist();
    }

    function initFromDom() {
      document.querySelectorAll('#rows tr[data-api]').forEach((row) => {
        const api = row.getAttribute('data-api');
        const control = row.getAttribute('data-control');
        const enabled = control !== 'off';
        const modeAttr = row.getAttribute('data-mode') || 'once';
        const mode = modeAttr.startsWith('cycle') ? 'cycle' : 'once';
        const cycleType = row.getAttribute('data-cycle-type') || (modeAttr.endsWith('day') ? 'day' : 'month');
        const remaining = toInt(row.getAttribute('data-remaining'), enabled ? 0 : 0);
        const used = toInt(row.getAttribute('data-used'), enabled ? 0 : 0);
        const cycleQuota = toInt(row.getAttribute('data-cycle-quota'), 0);
        const quota = enabled ? (mode === 'cycle' ? cycleQuota : (remaining + used)) : (remaining + used);
        state.set(api, { api, enabled, mode, cycleType, remaining, used, cycleQuota, quota });
      });
    }

    function persist() {
      const obj = {};
      for (const [k, v] of state.entries()) obj[k] = v;
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); } catch (_) {}
    }

    function restore() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const obj = JSON.parse(raw);
        for (const [k, v] of Object.entries(obj)) {
          if (state.has(k)) state.set(k, v);
        }
      } catch (_) {}
    }

    /* Modal helpers */
    const modalControl = document.getElementById('modalControl');
    const modalAdjust = document.getElementById('modalAdjust');

    function showModal(el){ el.classList.add('show'); }
    function hideModal(el){ el.classList.remove('show'); }

    document.querySelectorAll('.modal-backdrop').forEach((m) => {
      m.addEventListener('click', (e) => {
        if (e.target === m) hideModal(m);
      });
    });

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;

      const closeId = btn.getAttribute('data-close');
      if (closeId) {
        hideModal(document.getElementById(closeId));
        return;
      }

      const action = btn.getAttribute('data-action');
      if (!action) return;

      const row = btn.closest('tr');
      if (!row) return;
      const api = row.getAttribute('data-api');

      if (action === 'set-control') openControl(api);
    });

    /* Control modal */
    const controlApi = document.getElementById('controlApi');
    const controlEnabled = document.getElementById('controlEnabled');
    const controlMode = document.getElementById('controlMode');
    const cycleTypeWrap = document.getElementById('cycleTypeWrap');
    const cycleType = document.getElementById('cycleType');
    const onceWrap = document.getElementById('onceWrap');
    const onceRemaining = document.getElementById('onceRemaining');
    const cycleWrap = document.getElementById('cycleWrap');
    const cycleQuota = document.getElementById('cycleQuota');

    function syncModeUI(){
      const isCycle = controlMode.value === 'cycle';
      cycleTypeWrap.style.display = isCycle ? '' : 'none';
      cycleWrap.style.display = isCycle ? '' : 'none';
      onceWrap.style.display = isCycle ? 'none' : '';
    }

    controlMode.addEventListener('change', syncModeUI);

    function openControl(api) {
      const cfg = state.get(api);
      controlApi.textContent = api;
      controlApi.setAttribute('data-api', api);
      controlEnabled.checked = !!cfg.enabled;
      controlMode.value = cfg.mode;
      cycleType.value = cfg.cycleType;
      onceRemaining.value = cfg.mode === 'once' ? String(cfg.quota ?? (cfg.remaining + cfg.used)) : '';
      cycleQuota.value = cfg.mode === 'cycle' ? String(cfg.cycleQuota || cfg.quota || (cfg.remaining + cfg.used)) : '';
      syncModeUI();
      showModal(modalControl);
    }

    document.querySelector('[data-save="control"]').addEventListener('click', () => {
      const api = controlApi.getAttribute('data-api');
      const cfg = state.get(api);
      const enabled = controlEnabled.checked;
      const mode = controlMode.value;
      const next = { ...cfg, enabled, mode };

      if (enabled) {
        if (mode === 'once') {
          const quota = toInt(onceRemaining.value, -1);
          if (quota < 0) return toast('danger', '保存失败', '请填写“可发余量(段)”。');
          next.quota = quota;
          next.remaining = Math.max(0, quota - next.used);
        } else {
          next.cycleType = cycleType.value;
          const quota = toInt(cycleQuota.value, -1);
          if (quota < 0) return toast('danger', '保存失败', '请填写“每周期可发量(段)”。');
          next.cycleQuota = quota;
          next.quota = quota;
          next.remaining = Math.max(0, quota - next.used);
        }
      }

      state.set(api, next);
      renderAll();
      hideModal(modalControl);
      toast('success', '已保存', `API账号 ${api} 的发送管控设置已经更新。`);
    });

        initFromDom();
    restore();
    renderAll();
    syncModeUI();
  </script>
</body>
</html>
